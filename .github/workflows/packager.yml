name: Direct Dylib Compiler
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Compiler Tools
        run: |
          sudo apt-get update
          # Instalăm doar compilatorul esențial, evitând pachetele vechi inexistente
          sudo apt-get install -y clang ldid

      - name: Setup iOS SDK
        run: |
          mkdir -p sdks
          # Descarcă SDK-ul 14.5 (stabil pentru arm64)
          curl -L https://github.com/theos/sdks/raw/master/iPhoneOS14.5.sdk.tar.xz -o sdk.tar.xz
          tar -xf sdk.tar.xz -C sdks

      - name: Compile Tweak.xm to Dylib
        run: |
          # Compilăm direct Tweak.xm folosind Clang
          # Folosim flag-ul -fno-modules pentru a ignora erorile de module de la ora 08:26
          clang++ -dynamiclib \
            -isysroot sdks/iPhoneOS14.5.sdk \
            -arch arm64 \
            -miphoneos-version-min=14.0 \
            -O2 -fno-modules -Wno-error \
            -framework Foundation -framework UIKit -framework CoreGraphics -framework QuartzCore \
            -I./template \
            -o OneStateMod.dylib \
            template/Tweak.xm

      - name: Sign Dylib
        run: |
          # Aplicăm semnătura digitală minimă pentru iOS
          ldid -S OneStateMod.dylib

      - name: Upload Dylib
        uses: actions/upload-artifact@v4
        with:
          name: OneStateMod-Dylib
          path: OneStateMod.dylib
