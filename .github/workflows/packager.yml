name: Direct Dylib Compiler
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    # Folosim 22.04 pentru stabilitatea librăriilor C++
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Compiler Tools
        run: |
          sudo apt-get update
          # Instalăm pachetele necesare pentru compilare cross-platform
          sudo apt-get install -y clang lld unzip libstdc++-12-dev
          # Descărcăm ldid manual pentru semnarea finală
          sudo curl -L https://github.com/ProcursusTeam/ldid/releases/download/v2.1.5-procursus7/ldid_linux_x86_64 -o /usr/local/bin/ldid
          sudo chmod +x /usr/local/bin/ldid

      - name: Setup iOS SDK
        run: |
          mkdir -p sdks
          curl -L https://github.com/theos/sdks/archive/refs/heads/master.zip -o sdks.zip
          unzip -q sdks.zip -d sdks
          echo "SDK_PATH=$(ls -d $GITHUB_WORKSPACE/sdks/sdks-master/iPhoneOS14.5.sdk)" >> $GITHUB_ENV

      - name: Compile Tweak.xm to Dylib
        run: |
          # REZOLVARE EROARE 09:24:
          # Adăugăm flag-ul '-stdlib=libc++' și forțăm path-ul către headerele C++
          # Includem și folderele interne pentru KittyMemory/Menu
          clang++ -target arm64-apple-ios14.0 \
            -fuse-ld=lld \
            -dynamiclib \
            -isysroot ${{ env.SDK_PATH }} \
            -O2 -fno-modules -Wno-error \
            -stdlib=libc++ \
            -framework Foundation -framework UIKit -framework CoreGraphics -framework QuartzCore \
            -I./template \
            -I./template/KittyMemory \
            -x objective-c++ \
            -o OneStateMod.dylib \
            template/Tweak.xm

      - name: Sign Dylib
        run: |
          ldid -S OneStateMod.dylib

      - name: Upload Dylib
        uses: actions/upload-artifact@v4
        with:
          name: OneStateMod-Dylib
          path: OneStateMod.dylib
